
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This repository contains the Python Emission Localization and Quantification software we call pyELQ. It is code used for gas dispersion modelling, in particular methane emissions detection, localization and quantification.">
      
      
        <meta name="author" content="pyELQ">
      
      
      
        <link rel="prev" href="../dispersion_model/">
      
      
        <link rel="next" href="../gaussian_plume/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Finite Volume - pyELQ Python Emission Localization and Quantification</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


  
  
    
      
      
        
      
      
    
  
  
  <style>:root{.md-tag.md-tag--pipelines{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20576%20512%22%3E%3C%21--%21%20Font%20Awesome%20Free%207.1.0%20by%20%40fontawesome%20-%20https%3A//fontawesome.com%20License%20-%20https%3A//fontawesome.com/license/free%20%28Icons%3A%20CC%20BY%204.0%2C%20Fonts%3A%20SIL%20OFL%201.1%2C%20Code%3A%20MIT%20License%29%20Copyright%202025%20Fonticons%2C%20Inc.--%3E%3Cpath%20d%3D%22M160%20169.3c28.3-12.3%2048-40.5%2048-73.3%200-44.2-35.8-80-80-80S48%2051.8%2048%2096c0%2032.8%2019.7%2061%2048%2073.3V224H32c-17.7%200-32%2014.3-32%2032s14.3%2032%2032%2032h224v54.7c-28.3%2012.3-48%2040.5-48%2073.3%200%2044.2%2035.8%2080%2080%2080s80-35.8%2080-80c0-32.8-19.7-61-48-73.3V288h224c17.7%200%2032-14.3%2032-32s-14.3-32-32-32h-64v-54.7c28.3-12.3%2048-40.5%2048-73.3%200-44.2-35.8-80-80-80s-80%2035.8-80%2080c0%2032.8%2019.7%2061%2048%2073.3V224H160z%22/%3E%3C/svg%3E');}}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#finite-volume-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="pyELQ Python Emission Localization and Quantification" class="md-header__button md-logo" aria-label="pyELQ Python Emission Localization and Quantification" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pyELQ Python Emission Localization and Quantification
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Finite Volume
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sede-open/pyELQ" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    pyELQ
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../component/component/" class="md-tabs__link">
          
  
  
    
  
  pyELQ User Guide

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="pyELQ Python Emission Localization and Quantification" class="md-nav__button md-logo" aria-label="pyELQ Python Emission Localization and Quantification" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    pyELQ Python Emission Localization and Quantification
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sede-open/pyELQ" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    pyELQ
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    pyELQ User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    pyELQ User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Components
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Components
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../component/component/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../component/background/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Background
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../component/error_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../component/offset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Offset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../component/source_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Source Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../coordinate_system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coordinate System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data_access/data_access/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Access
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dispersion Model
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dispersion Model
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dispersion_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Finite Volume
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Finite Volume
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume" class="md-nav__link">
    <span class="md-ellipsis">
      
        finite_volume
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolume
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolume">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_coupling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling_sections" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_coupling_sections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.finite_volume_time_step_solver" class="md-nav__link">
    <span class="md-ellipsis">
      
        finite_volume_time_step_solver
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_lookup_to_source_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate_coupling_lookup_to_source_map
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.propagate_solver_single_time_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        propagate_solver_single_time_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_forward_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_forward_matrix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_time_bins" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_time_bins
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.set_delta_time_cfl" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_delta_time_cfl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_grid_to_sensor" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate_coupling_grid_to_sensor
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeDimension
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolumeDimension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.get_dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_dimensions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolumeFace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.normal" class="md-nav__link">
    <span class="md-ellipsis">
      
        normal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.set_boundary_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_boundary_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_advection" class="md-nav__link">
    <span class="md-ellipsis">
      
        assign_advection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_diffusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        assign_diffusion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFaceLeft
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFaceRight
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.SolverDiagonals" class="md-nav__link">
    <span class="md-ellipsis">
      
        SolverDiagonals
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gaussian_plume/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gaussian Plume
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../site_layout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Site Layout
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dlm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DLM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gas_species/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gas Species
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Meteorology
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Meteorology
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../meteorology/meteorology/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../meteorology/meteorology_windfield/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windfield
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plotting/plot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Plotting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pre-Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sensor
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sensor
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sensor/sensor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sensor/beam/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Beam
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sensor/satellite/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Satellite
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../source_map/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Source Map
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_13" >
        
          
          <label class="md-nav__link" for="__nav_2_13" id="__nav_2_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Support Functions
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_13">
            <span class="md-nav__icon md-icon"></span>
            
  
    Support Functions
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../support_functions/spatio_temporal_interpolation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spatio Temporal Interpolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../support_functions/post_processing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Post Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume" class="md-nav__link">
    <span class="md-ellipsis">
      
        finite_volume
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolume
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolume">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_coupling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling_sections" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_coupling_sections
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.finite_volume_time_step_solver" class="md-nav__link">
    <span class="md-ellipsis">
      
        finite_volume_time_step_solver
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_lookup_to_source_map" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate_coupling_lookup_to_source_map
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.propagate_solver_single_time_step" class="md-nav__link">
    <span class="md-ellipsis">
      
        propagate_solver_single_time_step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_forward_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_forward_matrix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.compute_time_bins" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_time_bins
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.set_delta_time_cfl" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_delta_time_cfl
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_grid_to_sensor" class="md-nav__link">
    <span class="md-ellipsis">
      
        interpolate_coupling_grid_to_sensor
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeDimension
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolumeDimension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.__post_init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __post_init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.get_dimensions" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_dimensions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FiniteVolumeFace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.normal" class="md-nav__link">
    <span class="md-ellipsis">
      
        normal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.set_boundary_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_boundary_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_advection" class="md-nav__link">
    <span class="md-ellipsis">
      
        assign_advection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_diffusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        assign_diffusion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFaceLeft
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight" class="md-nav__link">
    <span class="md-ellipsis">
      
        FiniteVolumeFaceRight
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pyelq.dispersion_model.finite_volume.SolverDiagonals" class="md-nav__link">
    <span class="md-ellipsis">
      
        SolverDiagonals
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<!--
SPDX-FileCopyrightText: 2026 Shell Global Solutions International B.V. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
-->

<h1 id="finite-volume-model">Finite Volume Model</h1>


<div class="doc doc-object doc-module">



<a id="pyelq.dispersion_model.finite_volume"></a>
    <div class="doc doc-contents first">

        <p>Finite Volume Dispersion Model module.</p>
<p>Methods and classes for the finite volume method for the dispersion model.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.FiniteVolume" class="doc doc-heading">
            <code>FiniteVolume</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;code&gt;DispersionModel&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.dispersion_model.dispersion_model.DispersionModel&lt;/code&gt;)" href="../dispersion_model/#pyelq.dispersion_model.dispersion_model.DispersionModel">DispersionModel</a></code></p>



        <p>Dispersion model object which creates a coupling matrix using a finite volume solver.</p>
<p>Uses an advection-diffusion solver to create the coupling matrix between a set of source locations and a set of
sensor locations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.dimensions">dimensions</span></code></td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of FiniteVolumeDimension for each grid dimension (e.g., x, y, z).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.diffusion_constants">diffusion_constants</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>array of diffusion constants [x,y,z], units m^2/s.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.site_layout">site_layout</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;SiteLayout&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.dispersion_model.site_layout.SiteLayout&lt;/code&gt;)" href="../site_layout/#pyelq.dispersion_model.site_layout.SiteLayout">SiteLayout</a>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the layout of the site including cylinder coordinates and radii.
(default is None). If None, no obstacles are considered in the model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.dt">dt</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>time step (s) (default is None). (If None, the time step is set using the CFL condition).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.implicit_solver">implicit_solver</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, the solver uses implicit methods. (default is False).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.courant_number">courant_number</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Courant number which and represents the fraction of the grid cell that a fluid particle
can travel in one time step. It is used in calculating dt when not specified. Default is 0.5 which means
that a fluid particle can travel half the grid cell in one time step.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.burn_in_steady_state">burn_in_steady_state</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, the model runs a burn-in period to reach steady state before
computing coupling. (default is True).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.use_lookup_table">use_lookup_table</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, uses a lookup table for coupling matrix interpolation (default is True).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.grid_coordinates">grid_coordinates</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, number_dimensions), coordinates of the grid points.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.source_grid_link">source_grid_link</span></code></td>
            <td>
                  <code><span title="scipy.sparse.csr_array">csr_array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>is a sparse matrix linking the source map to the grid coordinates.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.cell_volume">cell_volume</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>volume of a single grid cell.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.total_number_cells">total_number_cells</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>total number of cells in the grid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.grid_size">grid_size</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>size of the grid in each dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.grid_centers">grid_centers</span></code></td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>centers of the grid cells in each dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.number_dimensions">number_dimensions</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of dimensions in the grid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.adv_diff_terms">adv_diff_terms</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains advection and diffusion terms for the solver matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.coupling_lookup_table">coupling_lookup_table</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>coupling matrix calculated for each grid cell in grid_coordinates computed
when use_lookup_table=True. It is used for interpolation of coupling values for new source locations without
the need to re-run the FV solver.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume.forward_matrix">forward_matrix</span></code></td>
            <td>
                  <code><span title="scipy.sparse.dia_array">dia_array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the solver matrix for the finite volume method.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolume._forward_matrix_transpose">_forward_matrix_transpose</span></code></td>
            <td>
                  <code><span title="scipy.sparse.dia_array">dia_array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the transpose of the solver matrix for the finite volume method.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FiniteVolume</span><span class="p">(</span><span class="n">DispersionModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispersion model object which creates a coupling matrix using a finite volume solver.</span>

<span class="sd">    Uses an advection-diffusion solver to create the coupling matrix between a set of source locations and a set of</span>
<span class="sd">    sensor locations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        dimensions (list): list of FiniteVolumeDimension for each grid dimension (e.g., x, y, z).</span>
<span class="sd">        diffusion_constants (np.ndarray): array of diffusion constants [x,y,z], units m^2/s.</span>
<span class="sd">        site_layout (Union[SiteLayout, None]): the layout of the site including cylinder coordinates and radii.</span>
<span class="sd">            (default is None). If None, no obstacles are considered in the model.</span>
<span class="sd">        dt (float): time step (s) (default is None). (If None, the time step is set using the CFL condition).</span>
<span class="sd">        implicit_solver (bool): if True, the solver uses implicit methods. (default is False).</span>
<span class="sd">        courant_number (float): Courant number which and represents the fraction of the grid cell that a fluid particle</span>
<span class="sd">            can travel in one time step. It is used in calculating dt when not specified. Default is 0.5 which means</span>
<span class="sd">            that a fluid particle can travel half the grid cell in one time step.</span>
<span class="sd">        burn_in_steady_state (bool): if True, the model runs a burn-in period to reach steady state before</span>
<span class="sd">            computing coupling. (default is True).</span>
<span class="sd">        use_lookup_table (bool): if True, uses a lookup table for coupling matrix interpolation (default is True).</span>

<span class="sd">        grid_coordinates (np.ndarray): shape=(total_number_cells, number_dimensions), coordinates of the grid points.</span>
<span class="sd">        source_grid_link (csr_array): is a sparse matrix linking the source map to the grid coordinates.</span>
<span class="sd">        cell_volume (float): volume of a single grid cell.</span>
<span class="sd">        total_number_cells (int): total number of cells in the grid.</span>
<span class="sd">        grid_size (tuple): size of the grid in each dimension.</span>
<span class="sd">        grid_centers (list): centers of the grid cells in each dimension.</span>
<span class="sd">        number_dimensions (int): number of dimensions in the grid.</span>
<span class="sd">        adv_diff_terms (dict): contains advection and diffusion terms for the solver matrix.</span>
<span class="sd">        coupling_lookup_table (np.ndarray): coupling matrix calculated for each grid cell in grid_coordinates computed</span>
<span class="sd">            when use_lookup_table=True. It is used for interpolation of coupling values for new source locations without</span>
<span class="sd">            the need to re-run the FV solver.</span>
<span class="sd">        forward_matrix (dia_array): the solver matrix for the finite volume method.</span>
<span class="sd">        _forward_matrix_transpose (dia_array): the transpose of the solver matrix for the finite volume method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">diffusion_constants</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">site_layout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SiteLayout</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">implicit_solver</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">courant_number</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">burn_in_steady_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">use_lookup_table</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grid_coordinates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">source_grid_link</span><span class="p">:</span> <span class="n">csr_array</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cell_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">total_number_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">grid_size</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">grid_centers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">number_dimensions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">adv_diff_terms</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">coupling_lookup_table</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">forward_matrix</span><span class="p">:</span> <span class="n">dia_array</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_forward_matrix_transpose</span><span class="p">:</span> <span class="n">dia_array</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post-initialization checks and setup.</span>

<span class="sd">        Creates the grid and neighbourhood for the finite volume solver, and uses the site layout to mask any obstacles</span>
<span class="sd">        from the solver grid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">ENU</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source_map.location must be an ENU object.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">find_index_obstacles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_neighbourhood</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_coupling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
        <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span>
        <span class="n">gas_object</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">GasSpecies</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_stacked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the coupling matrix for the finite volume method using a lookup table.</span>

<span class="sd">        If self.use_lookup_table == False, or if self.coupling_lookup_table is None, the coupling matrix is computed</span>
<span class="sd">        using the FV solver and stored in self.coupling_lookup_table. Otherwise, the coupling matrix is computed using a</span>
<span class="sd">        lookup table approach from the previously computed coupling matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): sensor object containing sensor observations.</span>
<span class="sd">            met_windfield (MeteorologyWindfield): meteorology object containing site layout and timeseries of wind data.</span>
<span class="sd">            gas_object (Union[GasSpecies, None]): optional input, a gas species object to correctly calculate the</span>
<span class="sd">                gas density which is used in the conversion of the units of the Gaussian plume coupling. Defaults to</span>
<span class="sd">                None.</span>
<span class="sd">            output_stacked (bool): if True, the coupling is stacked across sensors into a single np.ndarray. Otherwise,</span>
<span class="sd">                the coupling is returned as a dictionary with an entry per sensor. Defaults to False.</span>
<span class="sd">            **kwargs: additional keyword arguments. To accommodate some arguments used in</span>
<span class="sd">                GaussianPlume.compute_coupling but not required in FiniteVolume.</span>

<span class="sd">        Returns:</span>
<span class="sd">            output (Union[np.ndarray, dict]): List of arrays, single array or dictionary containing the plume coupling</span>
<span class="sd">                in hr/kg. If a dictionary of sensor objects is passed in and output_stacked=False, this function returns</span>
<span class="sd">                a dictionary consistent with the input dictionary keys, containing the corresponding plume coupling</span>
<span class="sd">                outputs for each sensor. If a dictionary of sensor objects is passed in and output_stacked=True, this</span>
<span class="sd">                function returns an np.ndarray containing the stacked coupling matrices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MeteorologyWindfield site layout does not match FiniteVolume site layout.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">ENU</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source_map.location must be an ENU object.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_coupling_sections</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span> <span class="o">=</span> <span class="n">coupling_sensor</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_coupling_lookup_to_source_map</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">coupling_sensor</span>
        <span class="k">if</span> <span class="n">output_stacked</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_coupling_sections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">:</span> <span class="n">GasSpecies</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the coupling sections for the finite volume method.</span>

<span class="sd">        Sections are defined by the source_on attribute of the sensor object. If source_on is None (not specified) or</span>
<span class="sd">        all ones, then it is treated as a single section of data and directly moves on to computing the coupling matrix.</span>

<span class="sd">        If there are multiple sections, then the coupling matrix is computed for each section separately and combined</span>
<span class="sd">        into a single coupling matrix. This avoids computational effort computing the forward model through time steps</span>
<span class="sd">        that are not required and can speed up the computational time substantially in this case. Sections are</span>
<span class="sd">        defined by the source_on attribute of the sensor object which indicates which time steps the source is on where</span>
<span class="sd">        0 indicates the source is off and integers starting from 1 indicate different source on sections.</span>

<span class="sd">        To avoid additional computational effort when a source is not emitting we do not compute the forward model when</span>
<span class="sd">        the source_on attribute of the sensor object is set to 0. When a source starts emitting we can either assume it</span>
<span class="sd">        was already emitting and calculate an equilibrium state by setting the burn_in_steady_state attribute to True.</span>
<span class="sd">        Or we assume it starts right then and set this burn_in_steady_state attribute to False. When a source stops</span>
<span class="sd">        emitting there is still some gas present in the area of interest and it will take some time for this gas to</span>
<span class="sd">        disperse out of the area. However we assume the solution will not improve enough during this time to warrant</span>
<span class="sd">        the additional computational effort to compute the forward model for this period. Which is why we stop computing</span>
<span class="sd">        the forward model again when the source_on attribute switches from 1 to 0.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): sensor data object.</span>
<span class="sd">            meteorology_object (MeteorologyWindfield): wind field data object.</span>
<span class="sd">            gas_object (GasSpecies): gas species object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            coupling_sensor (dict): coupling for each sensor, keys corresponding to each sensor: e.g.</span>
<span class="sd">                coupling_sensor[&#39;sensor_1&#39;] is the coupling matrix for sensor 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finite_volume_time_step_solver</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span>

        <span class="n">number_of_sections</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span><span class="p">)</span>
        <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_sections</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">subset_sensor_object</span> <span class="o">=</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">subset_sensor</span><span class="p">(</span><span class="n">section_index</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
            <span class="n">coupling_sensor_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finite_volume_time_step_solver</span><span class="p">(</span>
                <span class="n">subset_sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">section_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor</span><span class="o">.</span><span class="n">source_on</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">section_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">coupling_sensor_section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">coupling_sensor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finite_volume_time_step_solver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
        <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span>
        <span class="n">gas_object</span><span class="p">:</span> <span class="n">GasSpecies</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the finite volume coupling matrix, by time-stepping the solver.</span>

<span class="sd">        This function calculates the coupling between emission sources and sensor measurements based on a spatial wind</span>
<span class="sd">        field derived from meteorological data. The resulting coupling matrices model the transport of gas through a</span>
<span class="sd">        discretized domain. The coupling between emissions in all solver grid cells and concentrations in the same set</span>
<span class="sd">        of grid cells is calculated by time-stepping a finite volume solver for the advection-diffusion equation. In</span>
<span class="sd">        time bins where sensor observations occur, the coupling between any source locations in the source map and the</span>
<span class="sd">        locations where sensor observations were obtained are extracted and stored in the rows of the coupling matrix.</span>

<span class="sd">        If dt is not specified, it will be set automatically using a CFL-like condition via self.set_delta_time_cfl().</span>
<span class="sd">        If burn_in_steady_state is True, the model runs a burn-in period to reach steady state before computing any</span>
<span class="sd">        coupling values. The wind field during the burn-in period is assumed to be constant and the same as the wind</span>
<span class="sd">        field at the first time-step.</span>

<span class="sd">        If the coupling matrix is unstable (norm &gt; 1e3), an error is raised suggesting to check the CFL number and dt.</span>
<span class="sd">        This condition is checked every 10% of the time steps.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): sensor data object.</span>
<span class="sd">            meteorology_object (MeteorologyWindfield): wind field data object.</span>
<span class="sd">            gas_object (GasSpecies): gas species object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            coupling_sensor (dict): coupling matrix for each sensor and sources defined by source_grid_link units hr/kg.</span>
<span class="sd">                coupling_sensor keys corresponding to each source, e.g. coupling_sensor[&#39;sensor_1&#39;] =</span>
<span class="sd">                coupling matrix for sensor 1 with shape=(number of observations (sensor_1), number of sources).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">coupling_grid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time_bins</span><span class="p">,</span> <span class="n">time_index_sensor</span><span class="p">,</span> <span class="n">time_index_met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_bins</span><span class="p">(</span>
            <span class="n">sensor_object</span><span class="o">=</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="o">=</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span>
        <span class="p">)</span>
        <span class="n">sensor_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_sensor</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span>
        <span class="n">n_burn_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_number_burn_steps</span><span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span><span class="p">)</span>
        <span class="n">gas_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gas_density</span><span class="p">(</span>
            <span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">,</span> <span class="n">run_interpolation</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">met_windfield</span><span class="o">.</span><span class="n">calculate_spatial_wind_field</span><span class="p">(</span><span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i_time</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">n_burn_steps</span><span class="p">,</span> <span class="n">time_bins</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing coupling matrix&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">met_windfield</span><span class="o">.</span><span class="n">calculate_spatial_wind_field</span><span class="p">(</span>
                    <span class="n">time_index</span><span class="o">=</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">],</span> <span class="n">grid_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">gas_density</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gas_density_i</span> <span class="o">=</span> <span class="n">gas_density</span><span class="p">[</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gas_density_i</span> <span class="o">=</span> <span class="n">gas_density</span>
            <span class="n">coupling_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagate_solver_single_time_step</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">,</span> <span class="n">coupling_matrix</span><span class="o">=</span><span class="n">coupling_grid</span><span class="p">)</span>
            <span class="n">scaled_coupling</span> <span class="o">=</span> <span class="n">coupling_grid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">/</span> <span class="p">(</span><span class="n">gas_density_i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
            <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_coupling_grid_to_sensor</span><span class="p">(</span>
                <span class="n">sensor_object</span><span class="o">=</span><span class="n">sensor_object</span><span class="p">,</span>
                <span class="n">scaled_coupling</span><span class="o">=</span><span class="n">scaled_coupling</span><span class="p">,</span>
                <span class="n">time_index_sensor</span><span class="o">=</span><span class="n">time_index_sensor</span><span class="p">,</span>
                <span class="n">i_time</span><span class="o">=</span><span class="n">i_time</span><span class="p">,</span>
                <span class="n">coupling_sensor</span><span class="o">=</span><span class="n">coupling_sensor</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">i_time</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_bins</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">n_burn_steps</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">coupling_grid_sourcemap_norm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coupling_grid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">coupling_grid_sourcemap_norm</span> <span class="o">&gt;</span> <span class="mf">1e3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The coupling matrix is unstable, with matrix norm: </span><span class="si">{</span><span class="n">coupling_grid_sourcemap_norm</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;check the courant_number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> and calculated dt=&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">coupling_sensor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpolate_coupling_lookup_to_source_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the coupling matrix by interpolation from a lookup table.</span>

<span class="sd">        A coupling matrix from all solver grid centres to all observations is pre-computed and stored on the class.</span>
<span class="sd">        Coupling columns for new source locations can then be computed by interpolation from these pre-computed values.</span>

<span class="sd">        The coupling matrix used for lookup is taken from self.coupling_lookup_table which is a sparse matrix computed</span>
<span class="sd">        in self.finite_volume_time_step_solver().</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): sensor data object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            interpolated_coupling (dict): interpolated coupling matrix for each sensor and sources (units hr/kg).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interpolated_coupling</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">source_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">interpolated_coupling</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">lookup_table_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">interpolated_coupling</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interpolator</span><span class="p">(</span>
                <span class="n">lookup_table_values</span><span class="p">,</span> <span class="n">locations_to_interpolate</span><span class="o">=</span><span class="n">source_location</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">interpolated_coupling</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">propagate_solver_single_time_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span> <span class="n">coupling_matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-step the finite volume solver.</span>

<span class="sd">        Time-step the finite volume solver to map the coupling matrix at time t to the coupling matrix at time (t +</span>
<span class="sd">        dt).</span>

<span class="sd">        For each time step, the forward matrix is computed based on the current wind field. The coupling matrix is then</span>
<span class="sd">        evolved by a single time-step using either an implicit or explicit solver approach, depending on the value of</span>
<span class="sd">        self.implicit_solver.</span>

<span class="sd">        coupling_matrix will be a sparse csc_array with shape=(total_number_cells, number of sources)</span>

<span class="sd">        If minimum_contribution is set, all elements in the coupling matrix smaller than this number will be set to 0.</span>
<span class="sd">        This can speed up computation.</span>

<span class="sd">        Args:</span>
<span class="sd">            met_windfield (MeteorologyWindfield): meteorology object containing wind field information.</span>
<span class="sd">            coupling_matrix (Union[(sparse.csc_array, None]): shape=(self.total_number_cells, number of sources).</span>
<span class="sd">                coupling matrix matrix on the finite volume grid if None will get preallocated for future time steps</span>


<span class="sd">        Returns:</span>
<span class="sd">            coupling_matrix (sparse.csc_array): shape=(self.total_number_cells, number of sources). Coupling</span>
<span class="sd">                matrix on the finite volume grid. Represents the contribution of each cell to the source term in the</span>
<span class="sd">                transport equation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_forward_matrix</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coupling_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_solver</span><span class="p">:</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">coupling_matrix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span>
            <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="o">-</span><span class="n">spsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span><span class="o">.</span><span class="n">tocsc</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="p">):</span>
                <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="o">@</span> <span class="n">coupling_matrix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_contribution</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">coupling_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_contribution</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">coupling_matrix</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coupling_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">coupling_matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_forward_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the forward solver matrix. This can be used to step the solution forward in time.</span>

<span class="sd">        The matrix forward_matrix is constructed using the advection and diffusion terms computed for each face in the</span>
<span class="sd">        grid.</span>

<span class="sd">        The overall matrix equation for the FV solver is:</span>
<span class="sd">            (V / dt) * [c^(n+1) - c^(n)] + F @ c^(n) - G @ c^(n) = s</span>
<span class="sd">        where F is the matrix of advection term coefficients, G is the matrix of diffusion term coefficients, and s is</span>
<span class="sd">        the source term.</span>

<span class="sd">        Rearranging gives:</span>
<span class="sd">            c^(n+1) = R @ c^(n) + (dt / V) * s</span>
<span class="sd">        where R = I - (dt / V) * (F - G).</span>

<span class="sd">        The diagonals of the matrix are constructed using self._construct_diagonals_advection_diffusion() and combined</span>
<span class="sd">        using self._combine_advection_diffusion_terms().</span>

<span class="sd">        On first run, the matrix is constructed using self._construct_diagonal_matrix(). On subsequent runs, the matrix</span>
<span class="sd">        is updated using self._update_diagonal_matrix() which saves computational time by updating the sparse matrix in</span>
<span class="sd">        place.</span>

<span class="sd">        Args:</span>
<span class="sd">            met_windfield (MeteorologyWindfield): meteorology object containing wind field information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_advection_diffusion_terms_by_face</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construct_diagonals_advection_diffusion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine_advection_diffusion_terms</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_construct_diagonal_matrix</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagonal_matrix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_advection_diffusion_terms_by_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute advection and diffusion terms for each face in the grid.</span>

<span class="sd">        Loops over each dimension and face in the grid and computes the advection using the wind vector and the</span>
<span class="sd">        diffusion terms using the diffusion constants.</span>

<span class="sd">        Args:</span>
<span class="sd">            met_windfield (MeteorologyWindfield): meteorology object containing wind field information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i_dim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">wind_component</span> <span class="o">=</span> <span class="n">met_windfield</span><span class="o">.</span><span class="n">u_component</span>
            <span class="k">elif</span> <span class="n">i_dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wind_component</span> <span class="o">=</span> <span class="n">met_windfield</span><span class="o">.</span><span class="n">v_component</span>
            <span class="k">elif</span> <span class="n">i_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">wind_component</span> <span class="o">=</span> <span class="n">met_windfield</span><span class="o">.</span><span class="n">w_component</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wind_component</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">dim</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
                <span class="n">face</span><span class="o">.</span><span class="n">assign_advection</span><span class="p">(</span><span class="n">wind_component</span><span class="p">)</span>
                <span class="n">face</span><span class="o">.</span><span class="n">assign_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_constants</span><span class="p">[</span><span class="n">i_dim</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_construct_diagonals_advection_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the diagonals of the advection and diffusion contributions to the overall solver matrix.</span>

<span class="sd">        In the function self._combine_advection_diffusion_terms(), the coefficients of the advection</span>
<span class="sd">        terms are stored in the matrix F, and the coefficients of the diffusion terms are stored in the matrix G. This</span>
<span class="sd">        function creates the diagonals of the F and G matrices.</span>

<span class="sd">        The overall diagonals are cumulated by looping over the solver dimensions, and the cell faces in each dimension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_off_diags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;advection&quot;</span><span class="p">:</span> <span class="n">SolverDiagonals</span><span class="p">(),</span> <span class="s2">&quot;diffusion&quot;</span><span class="p">:</span> <span class="n">SolverDiagonals</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="n">num_off_diags</span><span class="p">))</span>
            <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">dim</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
                    <span class="n">face_term</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">+=</span> <span class="n">face_term</span><span class="o">.</span><span class="n">B_central</span>
                    <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span><span class="p">[:,</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">face_term</span><span class="o">.</span><span class="n">B_neighbour</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">+=</span> <span class="n">face_term</span><span class="o">.</span><span class="n">b_dirichlet</span>
                    <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">+=</span> <span class="n">face_term</span><span class="o">.</span><span class="n">b_neumann</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">term</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">term</span><span class="o">.</span><span class="n">B_central</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_combine_advection_diffusion_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine the advection and diffusion terms into the solver matrix.</span>

<span class="sd">        The overall matrix equation for the FV solver is:</span>
<span class="sd">            (V / dt) * [c^(n+1) - c^(n)] + F @ c^(n) - G @ c^(n) = s</span>
<span class="sd">        where F is the matrix of advection term coefficients, G is the matrix of diffusion term coefficients, and s is</span>
<span class="sd">        the source term.</span>

<span class="sd">        Rearranging gives:</span>
<span class="sd">            c^(n+1) = R @ c^(n) + (dt / V) * s</span>
<span class="sd">        where R = I - (dt / V) * (F - G).</span>

<span class="sd">        This function calculates the diagonals of the matrix R by combining the advection and diffusion terms. These</span>
<span class="sd">        diagonals are stored in self.adv_diff_terms[&#39;combined&#39;].B.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_diags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SolverDiagonals</span><span class="p">()</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="n">num_diags</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_solver</span><span class="p">:</span>
            <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span> <span class="o">+</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;advection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span> <span class="o">+</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;diffusion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;advection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">+</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;diffusion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_dirichlet</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;advection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">+</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;diffusion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_neumann</span>
        <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">b_neumann</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_construct_diagonal_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the diagonal matrix for the solver.</span>

<span class="sd">        This method creates a sparse diagonal matrix using the diagonals and the specified grid size.</span>

<span class="sd">        The diagonal index is constructed based on the number of dimensions and the grid size using ravel_multi_index.</span>
<span class="sd">        This index is used to place the diagonal elements in the correct location within the sparse matrix. It is</span>
<span class="sd">        designed to be consistent with the meshgrid with indexing=&quot;ij&quot; used to construct grid_coordinates in</span>
<span class="sd">        self._setup_grid().</span>

<span class="sd">        The transposed matrix self._forward_matrix_transpose is constructed to deal with the way the zero-padding works</span>
<span class="sd">        in dia_array then transposed to self.forward_matrix which is required for forward simulation.</span>

<span class="sd">        The matrix self._forward_matrix_transpose is also stored to allow quick updating in self._update_diagonal_matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">diagonal_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">start_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">):</span>
            <span class="n">diag_coord</span> <span class="o">=</span> <span class="n">start_coord</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">diag_coord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">diag_coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">diag_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>
            <span class="n">diagonal_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">diagonal_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">diag_coord</span><span class="p">,</span> <span class="o">-</span><span class="n">diag_coord</span><span class="p">])))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_matrix_transpose</span> <span class="o">=</span> <span class="n">dia_array</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">diagonal_index</span><span class="p">),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_matrix_transpose</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_diagonal_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the self.forward_matrix for the solver.</span>

<span class="sd">        This method updates the self.forward_matrix  using the updated adv_diff_terms Avoid reconstructing the sparse</span>
<span class="sd">        matrix and just updates the data in place for speed purposes.</span>

<span class="sd">        Since the forward_matrix is transposed, we need to update the transposed version of the forward matrix then</span>
<span class="sd">        transpose it back.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_forward_matrix_transpose</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward_matrix_transpose</span><span class="o">.</span><span class="n">T</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a structured Cartesian grid using the site limits and number of cells in each dimension.</span>

<span class="sd">        ENU CoordinateSystem reference location is taken from self.source_map.</span>

<span class="sd">        This method builds a multi-dimensional grid by discretizing the spatial domain into equally spaced cells</span>
<span class="sd">        along each axis (e.g., x, y, z).</span>

<span class="sd">        Grid construction uses np.meshgrid with indexing=&quot;ij&quot; to be consistent with the way the diagonals are</span>
<span class="sd">        constructed in self._construct_diagonal_matrix() and the way the neighbourhood is constructed in</span>
<span class="sd">        self._setup_neighbourhood(). &quot;ij&quot; is the matrix indexing convention, which means that the first dimension</span>
<span class="sd">        corresponds to rows and the second dimension corresponds to columns.</span>

<span class="sd">        Volume and Area Calculations:</span>
<span class="sd">            - self.cell_volume stores the volume of a single grid cell (product of widths).</span>
<span class="sd">            - For each dimension, self.cell_face_area is computed as the ratio of cell volume to that dimension&#39;s width,</span>
<span class="sd">                representing the area of a face perpendicular to the given axis.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">dim</span><span class="o">.</span><span class="n">cell_width</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">cell_centers</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">dim</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
                <span class="n">face</span><span class="o">.</span><span class="n">cell_volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span>
                <span class="n">face</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span> <span class="o">/</span> <span class="n">dim</span><span class="o">.</span><span class="n">cell_width</span>
        <span class="n">grid_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">cell_centers</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">],</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="n">grid_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span> <span class="o">=</span> <span class="n">ENU</span><span class="p">(</span>
            <span class="n">ref_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">ref_longitude</span><span class="p">,</span>
            <span class="n">ref_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">ref_latitude</span><span class="p">,</span>
            <span class="n">ref_altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">ref_altitude</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">east</span> <span class="o">=</span> <span class="n">grid_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">north</span> <span class="o">=</span> <span class="n">grid_coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">grid_coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">east</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_source_link</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_source_link</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the source link between the source map and the grid coordinates.</span>

<span class="sd">        This method creates a sparse matrix that links the source map to the grid coordinates.</span>

<span class="sd">        Used in the coupling matrix to link the source map to the grid coordinates.</span>

<span class="sd">        If there are no sources in the source map or if use_lookup_table is True, the source map locations are set to</span>
<span class="sd">        the grid coordinates and the source_grid_link is set to an identity matrix.</span>

<span class="sd">        If there are sources in the source map and use_lookup_table is False, a KDTree is used to find the nearest grid</span>
<span class="sd">        point for each source location. The source_grid_link is then created as a sparse matrix with ones at the</span>
<span class="sd">        locations of the nearest grid points and zeros elsewhere.</span>

<span class="sd">        self.source_grid_link is a sparse matrix linking the source map to the grid coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">nof_sources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">nof_sources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">eye_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">nof_sources</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">))</span>
            <span class="n">source_index</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_array</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_sources</span><span class="p">),</span> <span class="p">(</span><span class="n">source_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_sources</span><span class="p">)))),</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="n">n_sources</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_neighbourhood</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the neighborhood relationships for each cell in the grid across all dimensions.</span>

<span class="sd">        For a given dim and face, to find the neighbor indices for each cell, the index is unwrapped and converted to</span>
<span class="sd">        multi-dimensional indices using np.unravel_index.</span>
<span class="sd">            e.g. if grid_size = (10,10) then for the cell index 27,</span>
<span class="sd">                index_center = np.unravel_index(27, (10,10))  = (2,7)</span>
<span class="sd">            we find the neighbor index by shifting the multi-dimensional indices by the face shift:</span>
<span class="sd">            for left face in x-dimension, shift = -1, so the new multi-dimensional indices are (1, 7))</span>
<span class="sd">            then we convert back to the unwrapped index using</span>
<span class="sd">                index_neighbour = np.ravel_multi_index((1,7), (10,10)) = 17</span>
<span class="sd">            for right face in y-dimension, shift = 1, so the new multi-dimensional indices are (2, 8))</span>
<span class="sd">            then we convert back to the unwrapped index using</span>
<span class="sd">                index_neighbour = np.ravel_multi_index((2,8), (10,10)) = 28</span>
<span class="sd">        Cells that lie at the domain boundary (i.e., where a shift would move them outside the grid extent) are detected</span>
<span class="sd">        and handled:</span>
<span class="sd">            - Their neighbor index is set to `-9999` to indicate an invalid or non-existent neighbor.</span>
<span class="sd">            - They are classified as external boundaries.</span>

<span class="sd">        Cells adjacent to user-defined obstacles (as indicated by `self.site_layout.id_obstacle`) are specially treated.</span>
<span class="sd">        If a neighboring cell lies within an obstacle region, it&#39;s considered an invalid neighbor for flow or</span>
<span class="sd">        interaction purposes.</span>

<span class="sd">        For external boundaries, the method assigns Dirichlet or Neumann boundary conditions depending on the</span>
<span class="sd">        specification in the grid metadata for that dimension.</span>

<span class="sd">        Each grid dimension is updated with the following information for both &#39;left&#39; and &#39;right&#39; directions:</span>
<span class="sd">            - neighbour_index: array of neighbor indices for each cell (-9999 for out-of-bounds).</span>
<span class="sd">            - boundary_condition: array indicating the type of boundary condition (&#39;internal&#39;, &#39;dirichlet&#39;, &#39;neumann&#39;).</span>
<span class="sd">            - boundary_conditions: the boundary condition type for the current direction.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">dim</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
                <span class="n">index_center_shift</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index_center</span><span class="p">)</span>
                <span class="n">index_center_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_center_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">face</span><span class="o">.</span><span class="n">shift</span>
                <span class="n">face</span><span class="o">.</span><span class="n">neighbour_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span><span class="n">index_center_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>
                <span class="n">face</span><span class="o">.</span><span class="n">neighbour_index</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">neighbour_index</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">total_number_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">external_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                    <span class="n">index_center_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index_center_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dim</span><span class="o">.</span><span class="n">number_cells</span>
                <span class="p">)</span>
                <span class="n">face</span><span class="o">.</span><span class="n">neighbour_index</span><span class="p">[</span><span class="n">external_boundaries</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
                <span class="n">face</span><span class="o">.</span><span class="n">set_boundary_type</span><span class="p">(</span><span class="n">external_boundaries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_time_bins</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">:</span> <span class="n">Meteorology</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute discretized time bins for aligning sensor observations and meteorological data.</span>

<span class="sd">        This method constructs a uniform time grid (bins) based on the observation time range of the given sensors.</span>
<span class="sd">        The time resolution is determined by `self.dt`. If `self.dt` is not specified, it will be set automatically</span>
<span class="sd">        using a CFL-like condition via `self.set_delta_time_cfl()` based on the meteorology object.</span>

<span class="sd">        Once the time bins are established:</span>
<span class="sd">            - Each sensor&#39;s observation times are digitized to determine which time bin each observation belongs to.</span>
<span class="sd">            - A KDTree is used to find the closest meteorological time index corresponding to each time bin, mapping the</span>
<span class="sd">            wind field to the solver grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): Sensor data object</span>
<span class="sd">            meteorology_object (Meteorology): Meteorology data object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            time_bins (pd.DatetimeIndex): The array of uniformly spaced time bins (based on `self.dt`).</span>
<span class="sd">            time_index_sensor (dict): A dictionary mapping each sensor ID to its array of time bin indices.</span>
<span class="sd">            time_index_met (np.ndarray): An array mapping each time bin to the closest meteorological time index.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_delta_time_cfl</span><span class="p">(</span><span class="n">meteorology_object</span><span class="p">)</span>
        <span class="n">sensor_time</span> <span class="o">=</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">time_bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">sensor_time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="n">sensor_time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">),</span>
            <span class="n">freq</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
            <span class="n">inclusive</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">time_index_sensor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">time_index_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span>
                <span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                <span class="n">time_bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">meteorology_object</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">time_index_met</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time_bins</span><span class="p">,</span> <span class="n">time_index_sensor</span><span class="p">,</span> <span class="n">time_index_met</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_delta_time_cfl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">:</span> <span class="n">Meteorology</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use CFL condition to set the time step.</span>

<span class="sd">        The CFL condition is a stability criterion for numerical methods used in solving partial differential equations.</span>
<span class="sd">        It ensures that the numerical solution remains stable and converges to the true solution.</span>

<span class="sd">        The CFL condition for advection is given by:</span>
<span class="sd">            dt &lt;= min(dx / |u|)</span>
<span class="sd">        for all dimensions, where dx is the grid spacing and u is the velocity. This method calculates the maximum</span>
<span class="sd">        velocity in each dimension and sets the time step accordingly.</span>

<span class="sd">        The diffusion term is also considered in the CFL condition:</span>
<span class="sd">            dt &lt;= (dx^2) / (2 * K)</span>
<span class="sd">        for all dimensions, where K is self.diffusion_constants.</span>

<span class="sd">        dt is set to the minimum of the advection and diffusion time steps multiplied by self.courant_number.</span>

<span class="sd">        dt is rounded to the nearest 0.1s due to usage in pd.date_range in other parts of the code.</span>

<span class="sd">        Args:</span>
<span class="sd">            meteorology_object (Meteorology): meteorology object containing timeseries of wind data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">meteorology_object</span><span class="o">.</span><span class="n">wind_speed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meteorology_object</span><span class="o">.</span><span class="n">calculate_wind_speed_from_uv</span><span class="p">()</span>
        <span class="n">u_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">meteorology_object</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">dim</span><span class="o">.</span><span class="n">cell_width</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>

        <span class="n">dt_adv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">u_max</span>
        <span class="n">dt_diff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_constants</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">dt_adv</span><span class="p">,</span> <span class="n">dt_diff</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">interpolate_coupling_grid_to_sensor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
        <span class="n">scaled_coupling</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_array</span><span class="p">,</span>
        <span class="n">time_index_sensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">i_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">coupling_sensor</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate coupling grid values to sensor locations.</span>

<span class="sd">        Calculate the coupling for each sensor at a given time step. This function interpolates plume coupling values</span>
<span class="sd">        from the coupling matrix to each sensor&#39;s location for a specific time step, and updates the output dictionary</span>
<span class="sd">        with the results.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): object containing sensor data.</span>
<span class="sd">            scaled_coupling (sp.csr_array): The sparse matrix representing coupling values between sources and grid</span>
<span class="sd">                cells for the current time step.</span>
<span class="sd">            time_index_sensor (np.ndarray): An array mapping each sensor to its corresponding time step index.</span>
<span class="sd">            i_time (int): The index of the current time step.</span>
<span class="sd">            coupling_sensor (dict): The output dictionary to be updated with coupling values for each sensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            coupling_sensor (dict): The updated output dictionary with interpolated coupling values at each sensor</span>
<span class="sd">                location for the current time step.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">observation_index</span> <span class="o">=</span> <span class="n">time_index_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_time</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">observation_index</span><span class="p">):</span>
                <span class="n">sensor_location</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">)</span>
                <span class="n">coupling_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interpolator</span><span class="p">(</span>
                    <span class="n">scaled_coupling</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">locations_to_interpolate</span><span class="o">=</span><span class="n">sensor_location</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
                    <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">observation_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_interp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">observation_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">coupling_interp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">coupling_sensor</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_interpolator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tabular_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">locations_to_interpolate</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build an interpolator for given tabular values and interpolate at specified locations.</span>

<span class="sd">        Interpolates values at specified locations using interpolation with the method of choosing within the grid,</span>
<span class="sd">        and nearest-neighbor extrapolation for out-of-bounds points.</span>

<span class="sd">        Args:</span>
<span class="sd">            tabular_values (np.ndarray): Array of data values defined on the grid.</span>
<span class="sd">            locations_to_interpolate (np.ndarray): Points at which to evaluate the interpolator, shape (M, D), where D</span>
<span class="sd">                is the number of dimensions.</span>
<span class="sd">            method (str): Interpolation method to use. Options are &#39;linear&#39;, &#39;nearest&#39;, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            combined_result (np.ndarray): Interpolated values at the specified locations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">reshaped_values</span> <span class="o">=</span> <span class="n">tabular_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">method_interp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_centers</span><span class="p">,</span>
            <span class="n">reshaped_values</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nearest_interp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_centers</span><span class="p">,</span>
            <span class="n">reshaped_values</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">method_result</span> <span class="o">=</span> <span class="n">method_interp</span><span class="p">(</span><span class="n">locations_to_interpolate</span><span class="p">)</span>
        <span class="n">nearest_result</span> <span class="o">=</span> <span class="n">nearest_interp</span><span class="p">(</span><span class="n">locations_to_interpolate</span><span class="p">)</span>
        <span class="n">combined_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">method_result</span><span class="p">),</span> <span class="n">nearest_result</span><span class="p">,</span> <span class="n">method_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_sensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SensorGroup</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add beam knots to the sensor object for Beam sensors and convert all sensor locations to ENU coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_object (SensorGroup): SensorGroup object containing sensor observations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            sensor_object_beam_knots_added (SensorGroup): A new SensorGroup object with beam knots added for Beam</span>
<span class="sd">                sensors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sensor_object_beam_knots_added</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object_beam_knots_added</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sensor</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_enu</span><span class="p">(</span>
                <span class="n">ref_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_latitude</span><span class="p">,</span>
                <span class="n">ref_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_longitude</span><span class="p">,</span>
                <span class="n">ref_altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_altitude</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
                <span class="n">sensor_array</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="n">make_beam_knots</span><span class="p">(</span>
                    <span class="n">ref_latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_latitude</span><span class="p">,</span>
                    <span class="n">ref_longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_longitude</span><span class="p">,</span>
                    <span class="n">ref_altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="o">.</span><span class="n">ref_altitude</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sensor</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">sensor_array</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sensor_object_beam_knots_added</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_number_burn_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">:</span> <span class="n">Meteorology</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the number of burn-in steps for plume stabilization.</span>

<span class="sd">        Computes the approximate amount of time required for a gas parcel to traverse the entire solver domain, based on</span>
<span class="sd">        the initial wind conditions. Then, based on the model time step (self.dt), computes the approximate number of</span>
<span class="sd">        time steps required for the plume to stabilize before the main analysis begins.</span>

<span class="sd">        If burn_in_steady_state is False, the function returns 0.</span>

<span class="sd">        burn steps are calculated as:</span>
<span class="sd">        n_burn_steps = ceil(2 * max_domain_size / (max_wind_speed * dt))</span>
<span class="sd">        roughly the time for a plume to travel across the domain twice. Note only consider the horizontal dimensions.</span>

<span class="sd">        Args:</span>
<span class="sd">            meteorology_object (Meteorology): Object providing wind field or other meteorological data over time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            n_burn_steps (int): The number of burn steps to be used in the coupling calculations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn_in_steady_state</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">meteorology_object</span><span class="o">.</span><span class="n">calculate_wind_speed_from_uv</span><span class="p">()</span>
        <span class="n">n_burn_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="n">dim</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dim</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">meteorology_object</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">n_burn_steps</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Post-initialization checks and setup.</p>
<p>Creates the grid and neighbourhood for the finite volume solver, and uses the site layout to mask any obstacles
from the solver grid.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Post-initialization checks and setup.</span>

<span class="sd">    Creates the grid and neighbourhood for the finite volume solver, and uses the site layout to mask any obstacles</span>
<span class="sd">    from the solver grid.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">ENU</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source_map.location must be an ENU object.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_grid</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">find_index_obstacles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_neighbourhood</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_coupling</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_stacked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the coupling matrix for the finite volume method using a lookup table.</p>
<p>If self.use_lookup_table == False, or if self.coupling_lookup_table is None, the coupling matrix is computed
using the FV solver and stored in self.coupling_lookup_table. Otherwise, the coupling matrix is computed using a
lookup table approach from the previously computed coupling matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sensor object containing sensor observations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>met_windfield</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;MeteorologyWindfield&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology_windfield.MeteorologyWindfield&lt;/code&gt;)" href="../../meteorology/meteorology_windfield/#pyelq.meteorology.meteorology_windfield.MeteorologyWindfield">MeteorologyWindfield</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>meteorology object containing site layout and timeseries of wind data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gas_object</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;GasSpecies&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.gas_species.GasSpecies&lt;/code&gt;)" href="../../gas_species/#pyelq.gas_species.GasSpecies">GasSpecies</a>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional input, a gas species object to correctly calculate the
gas density which is used in the conversion of the units of the Gaussian plume coupling. Defaults to
None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_stacked</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, the coupling is stacked across sensors into a single np.ndarray. Otherwise,
the coupling is returned as a dictionary with an entry per sensor. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>additional keyword arguments. To accommodate some arguments used in
GaussianPlume.compute_coupling but not required in FiniteVolume.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>output</code></td>            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of arrays, single array or dictionary containing the plume coupling
in hr/kg. If a dictionary of sensor objects is passed in and output_stacked=False, this function returns
a dictionary consistent with the input dictionary keys, containing the corresponding plume coupling
outputs for each sensor. If a dictionary of sensor objects is passed in and output_stacked=True, this
function returns an np.ndarray containing the stacked coupling matrices.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_coupling</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
    <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span>
    <span class="n">gas_object</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">GasSpecies</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_stacked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the coupling matrix for the finite volume method using a lookup table.</span>

<span class="sd">    If self.use_lookup_table == False, or if self.coupling_lookup_table is None, the coupling matrix is computed</span>
<span class="sd">    using the FV solver and stored in self.coupling_lookup_table. Otherwise, the coupling matrix is computed using a</span>
<span class="sd">    lookup table approach from the previously computed coupling matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): sensor object containing sensor observations.</span>
<span class="sd">        met_windfield (MeteorologyWindfield): meteorology object containing site layout and timeseries of wind data.</span>
<span class="sd">        gas_object (Union[GasSpecies, None]): optional input, a gas species object to correctly calculate the</span>
<span class="sd">            gas density which is used in the conversion of the units of the Gaussian plume coupling. Defaults to</span>
<span class="sd">            None.</span>
<span class="sd">        output_stacked (bool): if True, the coupling is stacked across sensors into a single np.ndarray. Otherwise,</span>
<span class="sd">            the coupling is returned as a dictionary with an entry per sensor. Defaults to False.</span>
<span class="sd">        **kwargs: additional keyword arguments. To accommodate some arguments used in</span>
<span class="sd">            GaussianPlume.compute_coupling but not required in FiniteVolume.</span>

<span class="sd">    Returns:</span>
<span class="sd">        output (Union[np.ndarray, dict]): List of arrays, single array or dictionary containing the plume coupling</span>
<span class="sd">            in hr/kg. If a dictionary of sensor objects is passed in and output_stacked=False, this function returns</span>
<span class="sd">            a dictionary consistent with the input dictionary keys, containing the corresponding plume coupling</span>
<span class="sd">            outputs for each sensor. If a dictionary of sensor objects is passed in and output_stacked=True, this</span>
<span class="sd">            function returns an np.ndarray containing the stacked coupling matrices.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MeteorologyWindfield site layout does not match FiniteVolume site layout.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">ENU</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;source_map.location must be an ENU object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_coupling_sections</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span> <span class="o">=</span> <span class="n">coupling_sensor</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lookup_table</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_coupling_lookup_to_source_map</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">coupling_sensor</span>
    <span class="k">if</span> <span class="n">output_stacked</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.compute_coupling_sections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_coupling_sections</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the coupling sections for the finite volume method.</p>
<p>Sections are defined by the source_on attribute of the sensor object. If source_on is None (not specified) or
all ones, then it is treated as a single section of data and directly moves on to computing the coupling matrix.</p>
<p>If there are multiple sections, then the coupling matrix is computed for each section separately and combined
into a single coupling matrix. This avoids computational effort computing the forward model through time steps
that are not required and can speed up the computational time substantially in this case. Sections are
defined by the source_on attribute of the sensor object which indicates which time steps the source is on where
0 indicates the source is off and integers starting from 1 indicate different source on sections.</p>
<p>To avoid additional computational effort when a source is not emitting we do not compute the forward model when
the source_on attribute of the sensor object is set to 0. When a source starts emitting we can either assume it
was already emitting and calculate an equilibrium state by setting the burn_in_steady_state attribute to True.
Or we assume it starts right then and set this burn_in_steady_state attribute to False. When a source stops
emitting there is still some gas present in the area of interest and it will take some time for this gas to
disperse out of the area. However we assume the solution will not improve enough during this time to warrant
the additional computational effort to compute the forward model for this period. Which is why we stop computing
the forward model again when the source_on attribute switches from 1 to 0.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sensor data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meteorology_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;MeteorologyWindfield&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology_windfield.MeteorologyWindfield&lt;/code&gt;)" href="../../meteorology/meteorology_windfield/#pyelq.meteorology.meteorology_windfield.MeteorologyWindfield">MeteorologyWindfield</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>wind field data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gas_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;GasSpecies&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.gas_species.GasSpecies&lt;/code&gt;)" href="../../gas_species/#pyelq.gas_species.GasSpecies">GasSpecies</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gas species object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>coupling_sensor</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>coupling for each sensor, keys corresponding to each sensor: e.g.
coupling_sensor['sensor_1'] is the coupling matrix for sensor 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_coupling_sections</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">:</span> <span class="n">GasSpecies</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the coupling sections for the finite volume method.</span>

<span class="sd">    Sections are defined by the source_on attribute of the sensor object. If source_on is None (not specified) or</span>
<span class="sd">    all ones, then it is treated as a single section of data and directly moves on to computing the coupling matrix.</span>

<span class="sd">    If there are multiple sections, then the coupling matrix is computed for each section separately and combined</span>
<span class="sd">    into a single coupling matrix. This avoids computational effort computing the forward model through time steps</span>
<span class="sd">    that are not required and can speed up the computational time substantially in this case. Sections are</span>
<span class="sd">    defined by the source_on attribute of the sensor object which indicates which time steps the source is on where</span>
<span class="sd">    0 indicates the source is off and integers starting from 1 indicate different source on sections.</span>

<span class="sd">    To avoid additional computational effort when a source is not emitting we do not compute the forward model when</span>
<span class="sd">    the source_on attribute of the sensor object is set to 0. When a source starts emitting we can either assume it</span>
<span class="sd">    was already emitting and calculate an equilibrium state by setting the burn_in_steady_state attribute to True.</span>
<span class="sd">    Or we assume it starts right then and set this burn_in_steady_state attribute to False. When a source stops</span>
<span class="sd">    emitting there is still some gas present in the area of interest and it will take some time for this gas to</span>
<span class="sd">    disperse out of the area. However we assume the solution will not improve enough during this time to warrant</span>
<span class="sd">    the additional computational effort to compute the forward model for this period. Which is why we stop computing</span>
<span class="sd">    the forward model again when the source_on attribute switches from 1 to 0.</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): sensor data object.</span>
<span class="sd">        meteorology_object (MeteorologyWindfield): wind field data object.</span>
<span class="sd">        gas_object (GasSpecies): gas species object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        coupling_sensor (dict): coupling for each sensor, keys corresponding to each sensor: e.g.</span>
<span class="sd">            coupling_sensor[&#39;sensor_1&#39;] is the coupling matrix for sensor 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">finite_volume_time_step_solver</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span>

    <span class="n">number_of_sections</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sensor_object</span><span class="o">.</span><span class="n">source_on</span><span class="p">)</span>
    <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_sections</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">subset_sensor_object</span> <span class="o">=</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">subset_sensor</span><span class="p">(</span><span class="n">section_index</span><span class="o">=</span><span class="n">section</span><span class="p">)</span>
        <span class="n">coupling_sensor_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finite_volume_time_step_solver</span><span class="p">(</span>
            <span class="n">subset_sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">section_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor</span><span class="o">.</span><span class="n">source_on</span> <span class="o">==</span> <span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">section_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">coupling_sensor_section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">coupling_sensor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.finite_volume_time_step_solver" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">finite_volume_time_step_solver</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the finite volume coupling matrix, by time-stepping the solver.</p>
<p>This function calculates the coupling between emission sources and sensor measurements based on a spatial wind
field derived from meteorological data. The resulting coupling matrices model the transport of gas through a
discretized domain. The coupling between emissions in all solver grid cells and concentrations in the same set
of grid cells is calculated by time-stepping a finite volume solver for the advection-diffusion equation. In
time bins where sensor observations occur, the coupling between any source locations in the source map and the
locations where sensor observations were obtained are extracted and stored in the rows of the coupling matrix.</p>
<p>If dt is not specified, it will be set automatically using a CFL-like condition via self.set_delta_time_cfl().
If burn_in_steady_state is True, the model runs a burn-in period to reach steady state before computing any
coupling values. The wind field during the burn-in period is assumed to be constant and the same as the wind
field at the first time-step.</p>
<p>If the coupling matrix is unstable (norm &gt; 1e3), an error is raised suggesting to check the CFL number and dt.
This condition is checked every 10% of the time steps.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sensor data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meteorology_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;MeteorologyWindfield&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology_windfield.MeteorologyWindfield&lt;/code&gt;)" href="../../meteorology/meteorology_windfield/#pyelq.meteorology.meteorology_windfield.MeteorologyWindfield">MeteorologyWindfield</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>wind field data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gas_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;GasSpecies&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.gas_species.GasSpecies&lt;/code&gt;)" href="../../gas_species/#pyelq.gas_species.GasSpecies">GasSpecies</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>gas species object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>coupling_sensor</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>coupling matrix for each sensor and sources defined by source_grid_link units hr/kg.
coupling_sensor keys corresponding to each source, e.g. coupling_sensor['sensor_1'] =
coupling matrix for sensor 1 with shape=(number of observations (sensor_1), number of sources).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">finite_volume_time_step_solver</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
    <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span>
    <span class="n">gas_object</span><span class="p">:</span> <span class="n">GasSpecies</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the finite volume coupling matrix, by time-stepping the solver.</span>

<span class="sd">    This function calculates the coupling between emission sources and sensor measurements based on a spatial wind</span>
<span class="sd">    field derived from meteorological data. The resulting coupling matrices model the transport of gas through a</span>
<span class="sd">    discretized domain. The coupling between emissions in all solver grid cells and concentrations in the same set</span>
<span class="sd">    of grid cells is calculated by time-stepping a finite volume solver for the advection-diffusion equation. In</span>
<span class="sd">    time bins where sensor observations occur, the coupling between any source locations in the source map and the</span>
<span class="sd">    locations where sensor observations were obtained are extracted and stored in the rows of the coupling matrix.</span>

<span class="sd">    If dt is not specified, it will be set automatically using a CFL-like condition via self.set_delta_time_cfl().</span>
<span class="sd">    If burn_in_steady_state is True, the model runs a burn-in period to reach steady state before computing any</span>
<span class="sd">    coupling values. The wind field during the burn-in period is assumed to be constant and the same as the wind</span>
<span class="sd">    field at the first time-step.</span>

<span class="sd">    If the coupling matrix is unstable (norm &gt; 1e3), an error is raised suggesting to check the CFL number and dt.</span>
<span class="sd">    This condition is checked every 10% of the time steps.</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): sensor data object.</span>
<span class="sd">        meteorology_object (MeteorologyWindfield): wind field data object.</span>
<span class="sd">        gas_object (GasSpecies): gas species object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        coupling_sensor (dict): coupling matrix for each sensor and sources defined by source_grid_link units hr/kg.</span>
<span class="sd">            coupling_sensor keys corresponding to each source, e.g. coupling_sensor[&#39;sensor_1&#39;] =</span>
<span class="sd">            coupling matrix for sensor 1 with shape=(number of observations (sensor_1), number of sources).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">coupling_grid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time_bins</span><span class="p">,</span> <span class="n">time_index_sensor</span><span class="p">,</span> <span class="n">time_index_met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_bins</span><span class="p">(</span>
        <span class="n">sensor_object</span><span class="o">=</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="o">=</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span>
    <span class="p">)</span>
    <span class="n">sensor_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_sensor</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span>
    <span class="n">n_burn_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_number_burn_steps</span><span class="p">(</span><span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span><span class="p">)</span>
    <span class="n">gas_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gas_density</span><span class="p">(</span>
        <span class="n">met_windfield</span><span class="o">.</span><span class="n">static_wind_field</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">,</span> <span class="n">gas_object</span><span class="p">,</span> <span class="n">run_interpolation</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">met_windfield</span><span class="o">.</span><span class="n">calculate_spatial_wind_field</span><span class="p">(</span><span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i_time</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">n_burn_steps</span><span class="p">,</span> <span class="n">time_bins</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing coupling matrix&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">]</span> <span class="o">!=</span> <span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="n">met_windfield</span><span class="o">.</span><span class="n">calculate_spatial_wind_field</span><span class="p">(</span>
                <span class="n">time_index</span><span class="o">=</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">],</span> <span class="n">grid_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_coordinates</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">gas_density</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">gas_density_i</span> <span class="o">=</span> <span class="n">gas_density</span><span class="p">[</span><span class="n">time_index_met</span><span class="p">[</span><span class="n">i_time</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gas_density_i</span> <span class="o">=</span> <span class="n">gas_density</span>
        <span class="n">coupling_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagate_solver_single_time_step</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">,</span> <span class="n">coupling_matrix</span><span class="o">=</span><span class="n">coupling_grid</span><span class="p">)</span>
        <span class="n">scaled_coupling</span> <span class="o">=</span> <span class="n">coupling_grid</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1e6</span> <span class="o">/</span> <span class="p">(</span><span class="n">gas_density_i</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">))</span>
        <span class="n">coupling_sensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_coupling_grid_to_sensor</span><span class="p">(</span>
            <span class="n">sensor_object</span><span class="o">=</span><span class="n">sensor_object</span><span class="p">,</span>
            <span class="n">scaled_coupling</span><span class="o">=</span><span class="n">scaled_coupling</span><span class="p">,</span>
            <span class="n">time_index_sensor</span><span class="o">=</span><span class="n">time_index_sensor</span><span class="p">,</span>
            <span class="n">i_time</span><span class="o">=</span><span class="n">i_time</span><span class="p">,</span>
            <span class="n">coupling_sensor</span><span class="o">=</span><span class="n">coupling_sensor</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">i_time</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_bins</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">n_burn_steps</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">coupling_grid_sourcemap_norm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">coupling_grid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">coupling_grid_sourcemap_norm</span> <span class="o">&gt;</span> <span class="mf">1e3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The coupling matrix is unstable, with matrix norm: </span><span class="si">{</span><span class="n">coupling_grid_sourcemap_norm</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;check the courant_number=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> and calculated dt=&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> s&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">coupling_sensor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_lookup_to_source_map" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">interpolate_coupling_lookup_to_source_map</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the coupling matrix by interpolation from a lookup table.</p>
<p>A coupling matrix from all solver grid centres to all observations is pre-computed and stored on the class.
Coupling columns for new source locations can then be computed by interpolation from these pre-computed values.</p>
<p>The coupling matrix used for lookup is taken from self.coupling_lookup_table which is a sparse matrix computed
in self.finite_volume_time_step_solver().</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sensor data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>interpolated_coupling</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>interpolated coupling matrix for each sensor and sources (units hr/kg).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interpolate_coupling_lookup_to_source_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the coupling matrix by interpolation from a lookup table.</span>

<span class="sd">    A coupling matrix from all solver grid centres to all observations is pre-computed and stored on the class.</span>
<span class="sd">    Coupling columns for new source locations can then be computed by interpolation from these pre-computed values.</span>

<span class="sd">    The coupling matrix used for lookup is taken from self.coupling_lookup_table which is a sparse matrix computed</span>
<span class="sd">    in self.finite_volume_time_step_solver().</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): sensor data object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        interpolated_coupling (dict): interpolated coupling matrix for each sensor and sources (units hr/kg).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interpolated_coupling</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">source_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_map</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">interpolated_coupling</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">lookup_table_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coupling_lookup_table</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">interpolated_coupling</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interpolator</span><span class="p">(</span>
            <span class="n">lookup_table_values</span><span class="p">,</span> <span class="n">locations_to_interpolate</span><span class="o">=</span><span class="n">source_location</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">interpolated_coupling</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.propagate_solver_single_time_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">propagate_solver_single_time_step</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">,</span> <span class="n">coupling_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Time-step the finite volume solver.</p>
<p>Time-step the finite volume solver to map the coupling matrix at time t to the coupling matrix at time (t +
dt).</p>
<p>For each time step, the forward matrix is computed based on the current wind field. The coupling matrix is then
evolved by a single time-step using either an implicit or explicit solver approach, depending on the value of
self.implicit_solver.</p>
<p>coupling_matrix will be a sparse csc_array with shape=(total_number_cells, number of sources)</p>
<p>If minimum_contribution is set, all elements in the coupling matrix smaller than this number will be set to 0.
This can speed up computation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>met_windfield</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;MeteorologyWindfield&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology_windfield.MeteorologyWindfield&lt;/code&gt;)" href="../../meteorology/meteorology_windfield/#pyelq.meteorology.meteorology_windfield.MeteorologyWindfield">MeteorologyWindfield</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>meteorology object containing wind field information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coupling_matrix</code>
            </td>
            <td>
                  <code>Union[(sparse.csc_array, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(self.total_number_cells, number of sources).
coupling matrix matrix on the finite volume grid if None will get preallocated for future time steps</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>coupling_matrix</code></td>            <td>
                  <code><span title="sparse.csc_array">csc_array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(self.total_number_cells, number of sources). Coupling
matrix on the finite volume grid. Represents the contribution of each cell to the source term in the
transport equation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">propagate_solver_single_time_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">,</span> <span class="n">coupling_matrix</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Time-step the finite volume solver.</span>

<span class="sd">    Time-step the finite volume solver to map the coupling matrix at time t to the coupling matrix at time (t +</span>
<span class="sd">    dt).</span>

<span class="sd">    For each time step, the forward matrix is computed based on the current wind field. The coupling matrix is then</span>
<span class="sd">    evolved by a single time-step using either an implicit or explicit solver approach, depending on the value of</span>
<span class="sd">    self.implicit_solver.</span>

<span class="sd">    coupling_matrix will be a sparse csc_array with shape=(total_number_cells, number of sources)</span>

<span class="sd">    If minimum_contribution is set, all elements in the coupling matrix smaller than this number will be set to 0.</span>
<span class="sd">    This can speed up computation.</span>

<span class="sd">    Args:</span>
<span class="sd">        met_windfield (MeteorologyWindfield): meteorology object containing wind field information.</span>
<span class="sd">        coupling_matrix (Union[(sparse.csc_array, None]): shape=(self.total_number_cells, number of sources).</span>
<span class="sd">            coupling matrix matrix on the finite volume grid if None will get preallocated for future time steps</span>


<span class="sd">    Returns:</span>
<span class="sd">        coupling_matrix (sparse.csc_array): shape=(self.total_number_cells, number of sources). Coupling</span>
<span class="sd">            matrix on the finite volume grid. Represents the contribution of each cell to the source term in the</span>
<span class="sd">            transport equation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compute_forward_matrix</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">coupling_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_volume</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_solver</span><span class="p">:</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">coupling_matrix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span>
        <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="o">-</span><span class="n">spsolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span><span class="o">.</span><span class="n">tocsc</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="p">):</span>
            <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csc_array</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coupling_matrix</span> <span class="o">=</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="o">@</span> <span class="n">coupling_matrix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_grid_link</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_contribution</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">coupling_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">coupling_matrix</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_contribution</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">coupling_matrix</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">coupling_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">coupling_matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.compute_forward_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_forward_matrix</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct the forward solver matrix. This can be used to step the solution forward in time.</p>
<p>The matrix forward_matrix is constructed using the advection and diffusion terms computed for each face in the
grid.</p>


<details class="the-overall-matrix-equation-for-the-fv-solver-is" open>
  <summary>The overall matrix equation for the FV solver is</summary>
  <p>(V / dt) * [c^(n+1) - c^(n)] + F @ c^(n) - G @ c^(n) = s</p>
</details>        <p>where F is the matrix of advection term coefficients, G is the matrix of diffusion term coefficients, and s is
the source term.</p>


<details class="rearranging-gives" open>
  <summary>Rearranging gives</summary>
  <p>c^(n+1) = R @ c^(n) + (dt / V) * s</p>
</details>        <p>where R = I - (dt / V) * (F - G).</p>
<p>The diagonals of the matrix are constructed using self._construct_diagonals_advection_diffusion() and combined
using self._combine_advection_diffusion_terms().</p>
<p>On first run, the matrix is constructed using self._construct_diagonal_matrix(). On subsequent runs, the matrix
is updated using self._update_diagonal_matrix() which saves computational time by updating the sparse matrix in
place.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>met_windfield</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;MeteorologyWindfield&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology_windfield.MeteorologyWindfield&lt;/code&gt;)" href="../../meteorology/meteorology_windfield/#pyelq.meteorology.meteorology_windfield.MeteorologyWindfield">MeteorologyWindfield</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>meteorology object containing wind field information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_forward_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met_windfield</span><span class="p">:</span> <span class="n">MeteorologyWindfield</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the forward solver matrix. This can be used to step the solution forward in time.</span>

<span class="sd">    The matrix forward_matrix is constructed using the advection and diffusion terms computed for each face in the</span>
<span class="sd">    grid.</span>

<span class="sd">    The overall matrix equation for the FV solver is:</span>
<span class="sd">        (V / dt) * [c^(n+1) - c^(n)] + F @ c^(n) - G @ c^(n) = s</span>
<span class="sd">    where F is the matrix of advection term coefficients, G is the matrix of diffusion term coefficients, and s is</span>
<span class="sd">    the source term.</span>

<span class="sd">    Rearranging gives:</span>
<span class="sd">        c^(n+1) = R @ c^(n) + (dt / V) * s</span>
<span class="sd">    where R = I - (dt / V) * (F - G).</span>

<span class="sd">    The diagonals of the matrix are constructed using self._construct_diagonals_advection_diffusion() and combined</span>
<span class="sd">    using self._combine_advection_diffusion_terms().</span>

<span class="sd">    On first run, the matrix is constructed using self._construct_diagonal_matrix(). On subsequent runs, the matrix</span>
<span class="sd">    is updated using self._update_diagonal_matrix() which saves computational time by updating the sparse matrix in</span>
<span class="sd">    place.</span>

<span class="sd">    Args:</span>
<span class="sd">        met_windfield (MeteorologyWindfield): meteorology object containing wind field information.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compute_advection_diffusion_terms_by_face</span><span class="p">(</span><span class="n">met_windfield</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_construct_diagonals_advection_diffusion</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_combine_advection_diffusion_terms</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_construct_diagonal_matrix</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_diagonal_matrix</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.compute_time_bins" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_time_bins</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute discretized time bins for aligning sensor observations and meteorological data.</p>
<p>This method constructs a uniform time grid (bins) based on the observation time range of the given sensors.
The time resolution is determined by <code>self.dt</code>. If <code>self.dt</code> is not specified, it will be set automatically
using a CFL-like condition via <code>self.set_delta_time_cfl()</code> based on the meteorology object.</p>


<details class="once-the-time-bins-are-established" open>
  <summary>Once the time bins are established</summary>
  <ul>
<li>Each sensor's observation times are digitized to determine which time bin each observation belongs to.</li>
<li>A KDTree is used to find the closest meteorological time index corresponding to each time bin, mapping the
wind field to the solver grid.</li>
</ul>
</details>

<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sensor data object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>meteorology_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;Meteorology&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology.Meteorology&lt;/code&gt;)" href="../../meteorology/meteorology/#pyelq.meteorology.meteorology.Meteorology">Meteorology</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Meteorology data object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>time_bins</code></td>            <td>
                  <code><span title="pandas.DatetimeIndex">DatetimeIndex</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The array of uniformly spaced time bins (based on <code>self.dt</code>).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>time_index_sensor</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping each sensor ID to its array of time bin indices.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>time_index_met</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array mapping each time bin to the closest meteorological time index.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_time_bins</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">:</span> <span class="n">Meteorology</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute discretized time bins for aligning sensor observations and meteorological data.</span>

<span class="sd">    This method constructs a uniform time grid (bins) based on the observation time range of the given sensors.</span>
<span class="sd">    The time resolution is determined by `self.dt`. If `self.dt` is not specified, it will be set automatically</span>
<span class="sd">    using a CFL-like condition via `self.set_delta_time_cfl()` based on the meteorology object.</span>

<span class="sd">    Once the time bins are established:</span>
<span class="sd">        - Each sensor&#39;s observation times are digitized to determine which time bin each observation belongs to.</span>
<span class="sd">        - A KDTree is used to find the closest meteorological time index corresponding to each time bin, mapping the</span>
<span class="sd">        wind field to the solver grid.</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): Sensor data object</span>
<span class="sd">        meteorology_object (Meteorology): Meteorology data object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        time_bins (pd.DatetimeIndex): The array of uniformly spaced time bins (based on `self.dt`).</span>
<span class="sd">        time_index_sensor (dict): A dictionary mapping each sensor ID to its array of time bin indices.</span>
<span class="sd">        time_index_met (np.ndarray): An array mapping each time bin to the closest meteorological time index.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_delta_time_cfl</span><span class="p">(</span><span class="n">meteorology_object</span><span class="p">)</span>
    <span class="n">sensor_time</span> <span class="o">=</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">time_bins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">sensor_time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="n">sensor_time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">),</span>
        <span class="n">freq</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
        <span class="n">inclusive</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">time_index_sensor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">time_index_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span>
            <span class="n">sensor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="n">time_bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">meteorology_object</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">time_index_met</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time_bins</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time_bins</span><span class="p">,</span> <span class="n">time_index_sensor</span><span class="p">,</span> <span class="n">time_index_met</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.set_delta_time_cfl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_delta_time_cfl</span><span class="p">(</span><span class="n">meteorology_object</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Use CFL condition to set the time step.</p>
<p>The CFL condition is a stability criterion for numerical methods used in solving partial differential equations.
It ensures that the numerical solution remains stable and converges to the true solution.</p>


<details class="the-cfl-condition-for-advection-is-given-by" open>
  <summary>The CFL condition for advection is given by</summary>
  <p>dt &lt;= min(dx / |u|)</p>
</details>        <p>for all dimensions, where dx is the grid spacing and u is the velocity. This method calculates the maximum
velocity in each dimension and sets the time step accordingly.</p>


<details class="the-diffusion-term-is-also-considered-in-the-cfl-condition" open>
  <summary>The diffusion term is also considered in the CFL condition</summary>
  <p>dt &lt;= (dx^2) / (2 * K)</p>
</details>        <p>for all dimensions, where K is self.diffusion_constants.</p>
<p>dt is set to the minimum of the advection and diffusion time steps multiplied by self.courant_number.</p>
<p>dt is rounded to the nearest 0.1s due to usage in pd.date_range in other parts of the code.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>meteorology_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;Meteorology&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.meteorology.meteorology.Meteorology&lt;/code&gt;)" href="../../meteorology/meteorology/#pyelq.meteorology.meteorology.Meteorology">Meteorology</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>meteorology object containing timeseries of wind data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_delta_time_cfl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meteorology_object</span><span class="p">:</span> <span class="n">Meteorology</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use CFL condition to set the time step.</span>

<span class="sd">    The CFL condition is a stability criterion for numerical methods used in solving partial differential equations.</span>
<span class="sd">    It ensures that the numerical solution remains stable and converges to the true solution.</span>

<span class="sd">    The CFL condition for advection is given by:</span>
<span class="sd">        dt &lt;= min(dx / |u|)</span>
<span class="sd">    for all dimensions, where dx is the grid spacing and u is the velocity. This method calculates the maximum</span>
<span class="sd">    velocity in each dimension and sets the time step accordingly.</span>

<span class="sd">    The diffusion term is also considered in the CFL condition:</span>
<span class="sd">        dt &lt;= (dx^2) / (2 * K)</span>
<span class="sd">    for all dimensions, where K is self.diffusion_constants.</span>

<span class="sd">    dt is set to the minimum of the advection and diffusion time steps multiplied by self.courant_number.</span>

<span class="sd">    dt is rounded to the nearest 0.1s due to usage in pd.date_range in other parts of the code.</span>

<span class="sd">    Args:</span>
<span class="sd">        meteorology_object (Meteorology): meteorology object containing timeseries of wind data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">meteorology_object</span><span class="o">.</span><span class="n">wind_speed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">meteorology_object</span><span class="o">.</span><span class="n">calculate_wind_speed_from_uv</span><span class="p">()</span>
    <span class="n">u_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">meteorology_object</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">dim</span><span class="o">.</span><span class="n">cell_width</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>

    <span class="n">dt_adv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">u_max</span>
    <span class="n">dt_diff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">courant_number</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusion_constants</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">dt_adv</span><span class="p">,</span> <span class="n">dt_diff</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolume.interpolate_coupling_grid_to_sensor" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">interpolate_coupling_grid_to_sensor</span><span class="p">(</span><span class="n">sensor_object</span><span class="p">,</span> <span class="n">scaled_coupling</span><span class="p">,</span> <span class="n">time_index_sensor</span><span class="p">,</span> <span class="n">i_time</span><span class="p">,</span> <span class="n">coupling_sensor</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Interpolate coupling grid values to sensor locations.</p>
<p>Calculate the coupling for each sensor at a given time step. This function interpolates plume coupling values
from the coupling matrix to each sensor's location for a specific time step, and updates the output dictionary
with the results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sensor_object</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="&lt;code&gt;SensorGroup&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.sensor.sensor.SensorGroup&lt;/code&gt;)" href="../../sensor/sensor/#pyelq.sensor.sensor.SensorGroup">SensorGroup</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>object containing sensor data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaled_coupling</code>
            </td>
            <td>
                  <code><span title="scipy.sparse.csr_array">csr_array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sparse matrix representing coupling values between sources and grid
cells for the current time step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_index_sensor</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An array mapping each sensor to its corresponding time step index.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>i_time</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The index of the current time step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>coupling_sensor</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output dictionary to be updated with coupling values for each sensor.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>coupling_sensor</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated output dictionary with interpolated coupling values at each sensor
location for the current time step.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">interpolate_coupling_grid_to_sensor</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sensor_object</span><span class="p">:</span> <span class="n">SensorGroup</span><span class="p">,</span>
    <span class="n">scaled_coupling</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_array</span><span class="p">,</span>
    <span class="n">time_index_sensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">i_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">coupling_sensor</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolate coupling grid values to sensor locations.</span>

<span class="sd">    Calculate the coupling for each sensor at a given time step. This function interpolates plume coupling values</span>
<span class="sd">    from the coupling matrix to each sensor&#39;s location for a specific time step, and updates the output dictionary</span>
<span class="sd">    with the results.</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_object (SensorGroup): object containing sensor data.</span>
<span class="sd">        scaled_coupling (sp.csr_array): The sparse matrix representing coupling values between sources and grid</span>
<span class="sd">            cells for the current time step.</span>
<span class="sd">        time_index_sensor (np.ndarray): An array mapping each sensor to its corresponding time step index.</span>
<span class="sd">        i_time (int): The index of the current time step.</span>
<span class="sd">        coupling_sensor (dict): The output dictionary to be updated with coupling values for each sensor.</span>

<span class="sd">    Returns:</span>
<span class="sd">        coupling_sensor (dict): The updated output dictionary with interpolated coupling values at each sensor</span>
<span class="sd">            location for the current time step.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensor_object</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">observation_index</span> <span class="o">=</span> <span class="n">time_index_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">i_time</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">observation_index</span><span class="p">):</span>
            <span class="n">sensor_location</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_dimensions</span><span class="p">)</span>
            <span class="n">coupling_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_interpolator</span><span class="p">(</span>
                <span class="n">scaled_coupling</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">locations_to_interpolate</span><span class="o">=</span><span class="n">sensor_location</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">Beam</span><span class="p">):</span>
                <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">observation_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_interp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coupling_sensor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">observation_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">coupling_interp</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">coupling_sensor</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension" class="doc doc-heading">
            <code>FiniteVolumeDimension</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Individual grid dimension for the finite volume method.</p>
<p>Assuming that each solver dimension is a regular grid, this class stores grid properties, such as cell edges,
centre points and cell widths.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.label">label</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of this dimension (e.g., 'x', 'y', 'z').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.number_cells">number_cells</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number of cells in this dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.limits">limits</span></code></td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>limits of this dimension (e.g., [0, 100]).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.external_boundary_type">external_boundary_type</span></code></td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>type of boundary condition for the faces in this dimension
e.g., external_boundary_type=['dirichlet', 'neumann'].
If only 1 type is specified, it is used for both faces of this dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.cell_edges">cell_edges</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(self.number_cells + 1,) edge locations for the cells in this dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.cell_centers">cell_centers</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(self.number_cells,) central locations of the cells in this dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.cell_width">cell_width</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>width of the cells in this dimension.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.faces">faces</span></code></td>
            <td>
                  <code>list(FiniteVolumeFaceLeft, FiniteVolumeFaceRight</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of objects corresponding to the left and right
(-ve and +ve) faces of this dimension.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FiniteVolumeDimension</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual grid dimension for the finite volume method.</span>

<span class="sd">    Assuming that each solver dimension is a regular grid, this class stores grid properties, such as cell edges,</span>
<span class="sd">    centre points and cell widths.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        label (str): name of this dimension (e.g., &#39;x&#39;, &#39;y&#39;, &#39;z&#39;).</span>
<span class="sd">        number_cells (int): number of cells in this dimension.</span>
<span class="sd">        limits (list): limits of this dimension (e.g., [0, 100]).</span>
<span class="sd">        external_boundary_type (list): type of boundary condition for the faces in this dimension</span>
<span class="sd">            e.g., external_boundary_type=[&#39;dirichlet&#39;, &#39;neumann&#39;].</span>
<span class="sd">            If only 1 type is specified, it is used for both faces of this dimension.</span>

<span class="sd">        cell_edges (np.ndarray): shape=(self.number_cells + 1,) edge locations for the cells in this dimension.</span>
<span class="sd">        cell_centers (np.ndarray): shape=(self.number_cells,) central locations of the cells in this dimension.</span>
<span class="sd">        cell_width (float): width of the cells in this dimension.</span>
<span class="sd">        faces (list(FiniteVolumeFaceLeft, FiniteVolumeFaceRight)): list of objects corresponding to the left and right</span>
<span class="sd">            (-ve and +ve) faces of this dimension.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">number_cells</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">limits</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">external_boundary_type</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">cell_edges</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cell_centers</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cell_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">faces</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post-initialization processing.</span>

<span class="sd">        Validates the external boundary types and initializes the face objects for the dimension. Also calls</span>
<span class="sd">        get_dimensions to calculate and store geometric properties of the dimension.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: external_boundary_type must one of [&#39;dirichlet&#39;, &#39;neumann&#39;].</span>
<span class="sd">            ValueError: number_cells must be at least 2.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;external_boundary_type must be a list.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_cells</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;number_cells must be at least 2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FiniteVolumeFaceLeft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">FiniteVolumeFaceRight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the face properties for the finite volume method.</span>

<span class="sd">        This function calculates and stores the grid cell edges, cell centres and cell widths, and assigns the cell</span>
<span class="sd">        width values to the cell faces.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
            <span class="n">face</span><span class="o">.</span><span class="n">cell_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.__post_init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__post_init__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Post-initialization processing.</p>
<p>Validates the external boundary types and initializes the face objects for the dimension. Also calls
get_dimensions to calculate and store geometric properties of the dimension.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>external_boundary_type must one of ['dirichlet', 'neumann'].</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>number_cells must be at least 2.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Post-initialization processing.</span>

<span class="sd">    Validates the external boundary types and initializes the face objects for the dimension. Also calls</span>
<span class="sd">    get_dimensions to calculate and store geometric properties of the dimension.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: external_boundary_type must one of [&#39;dirichlet&#39;, &#39;neumann&#39;].</span>
<span class="sd">        ValueError: number_cells must be at least 2.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;external_boundary_type must be a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_cells</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;number_cells must be at least 2&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FiniteVolumeFaceLeft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">FiniteVolumeFaceRight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_dimensions</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeDimension.get_dimensions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dimensions</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Setup the face properties for the finite volume method.</p>
<p>This function calculates and stores the grid cell edges, cell centres and cell widths, and assigns the cell
width values to the cell faces.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup the face properties for the finite volume method.</span>

<span class="sd">    This function calculates and stores the grid cell edges, cell centres and cell widths, and assigns the cell</span>
<span class="sd">    width values to the cell faces.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_cells</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">:</span>
        <span class="n">face</span><span class="o">.</span><span class="n">cell_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFace" class="doc doc-heading">
            <code>FiniteVolumeFace</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Face type for a grid cell in the finite volume method.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.external_boundary_type">external_boundary_type</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of boundary condition for the face. either 'dirichlet' or 'neumann'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.cell_face_area">cell_face_area</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The area of the face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.cell_volume">cell_volume</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The volume of the face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.cell_width">cell_width</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The width of the cell in the direction normal to the face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.boundary_type">boundary_type</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). The type of boundary condition for the face. Each
entry is a string, either 'internal', 'dirichlet' or 'neumann'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.neighbour_index">neighbour_index</span></code></td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). The index of the neighboring cell across the face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.adv_diff_terms">adv_diff_terms</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The advection and diffusion terms for the face. Dictionary has two entries: "advection"
and "diffusion", each containing a SolverDiagonals object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FiniteVolumeFace</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Face type for a grid cell in the finite volume method.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        external_boundary_type (str): The type of boundary condition for the face. either &#39;dirichlet&#39; or &#39;neumann&#39;.</span>

<span class="sd">        cell_face_area (float): The area of the face.</span>
<span class="sd">        cell_volume (float): The volume of the face.</span>
<span class="sd">        cell_width (float): The width of the cell in the direction normal to the face.</span>
<span class="sd">        boundary_type (np.ndarray): shape=(total_number_cells, 1). The type of boundary condition for the face. Each</span>
<span class="sd">            entry is a string, either &#39;internal&#39;, &#39;dirichlet&#39; or &#39;neumann&#39;.</span>
<span class="sd">        neighbour_index (np.ndarray): shape=(total_number_cells, 1). The index of the neighboring cell across the face.</span>
<span class="sd">        adv_diff_terms (dict): The advection and diffusion terms for the face. Dictionary has two entries: &quot;advection&quot;</span>
<span class="sd">            and &quot;diffusion&quot;, each containing a SolverDiagonals object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">external_boundary_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">cell_face_area</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cell_volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cell_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">boundary_type</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">neighbour_index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">adv_diff_terms</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abstract property to be defined in subclasses.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dirichlet&quot;</span><span class="p">,</span> <span class="s2">&quot;neumann&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid external boundary type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span><span class="si">}</span><span class="s2">. &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;advection&quot;</span><span class="p">:</span> <span class="n">SolverDiagonals</span><span class="p">(),</span> <span class="s2">&quot;diffusion&quot;</span><span class="p">:</span> <span class="n">SolverDiagonals</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_boundary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_boundaries</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">site_layout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SiteLayout</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the boundary condition for the face based on the external boundary type.</span>

<span class="sd">        External boundaries are set to &#39;dirichlet&#39; or &#39;neumann&#39; based on the specified external_boundary_type. Internal</span>
<span class="sd">        boundaries are set to &#39;internal&#39;.</span>

<span class="sd">        The function also handles the case where the face is affected by an obstacle. Obstacle boundaries are set to</span>
<span class="sd">        &#39;neumann&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            external_boundaries (np.ndarray): shape=(total_number_cells, 1). Boolean array indicating which faces are</span>
<span class="sd">                external boundaries.</span>
<span class="sd">            site_layout (Union[SiteLayout, None]): SiteLayout object containing obstacle information. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_index</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;&lt;U10&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="p">[</span><span class="n">external_boundaries</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span>
        <span class="k">if</span> <span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">faces_affected_obstacle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">faces_affected_obstacle</span><span class="p">,</span> <span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;neumann&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_advection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wind_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns the advection terms for the defined set of interfaces to adv_diff_terms[&#39;advection&#39;].</span>

<span class="sd">        Uses an upwind scheme for the discretization of the advection term:</span>
<span class="sd">        https://en.wikipedia.org/wiki/Upwind_scheme#:~:text=In#20computational#20physics#2C#20the#20term,derivatives#20in#20a#20flow#20field.</span>

<span class="sd">        Upwind scheme for a single dimension has the following form:</span>
<span class="sd">            F_i = A * [u^{+} * (c_i - c_{i-1}) + u^{-} * (c_{i+1} - c_{i})]</span>
<span class="sd">        where u^{+} = -min(-u, 0) and u^{-} = max(-u, 0), A is the face area, and indices corresponding to other</span>
<span class="sd">        dimensions have been dropped.</span>

<span class="sd">        Args:</span>
<span class="sd">            wind_vector (np.ndarray): shape=(total_number_cells, 1). Wind speed vector in dimension of this face</span>
<span class="sd">                e.g. x, y, z.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;advection&quot;</span><span class="p">]</span>
        <span class="n">u_norm</span> <span class="o">=</span> <span class="n">wind_vector</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal</span>
        <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">-</span><span class="n">u_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">neighbour_advection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">u_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;internal&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>
        <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;dirichlet&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>
        <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;neumann&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diffusion_constants</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns the diffusion terms for the defined set of interfaces to adv_diff_terms[&#39;diffusion&#39;].</span>

<span class="sd">        If diffusion is already set this function is skipped as the diffusion term is constant.</span>

<span class="sd">        The diffusion term for a single dimension has the following form:</span>
<span class="sd">            G_i = K * A * [(c_{i+1} - c_i) / delta - (c_i - c_{i-1}) / delta]</span>
<span class="sd">        where K is the diffusion constant, A is the face area, delta is the cell width, and indices corresponding to</span>
<span class="sd">        other dimensions have been dropped.</span>

<span class="sd">        Args:</span>
<span class="sd">            diffusion_constants (float) : diffusion coefficient in this dimension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;diffusion&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diffusion_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="n">diffusion_constants</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span>
            <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">=</span> <span class="o">-</span><span class="n">diffusion_coefficient</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;internal&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
            <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;dirichlet&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
            <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;neumann&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.normal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normal</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Abstract property to be defined in subclasses.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.set_boundary_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_boundary_type</span><span class="p">(</span><span class="n">external_boundaries</span><span class="p">,</span> <span class="n">site_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the boundary condition for the face based on the external boundary type.</p>
<p>External boundaries are set to 'dirichlet' or 'neumann' based on the specified external_boundary_type. Internal
boundaries are set to 'internal'.</p>
<p>The function also handles the case where the face is affected by an obstacle. Obstacle boundaries are set to
'neumann'.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>external_boundaries</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). Boolean array indicating which faces are
external boundaries.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>site_layout</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="&lt;code&gt;SiteLayout&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.dispersion_model.site_layout.SiteLayout&lt;/code&gt;)" href="../site_layout/#pyelq.dispersion_model.site_layout.SiteLayout">SiteLayout</a>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SiteLayout object containing obstacle information. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_boundary_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_boundaries</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">site_layout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SiteLayout</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the boundary condition for the face based on the external boundary type.</span>

<span class="sd">    External boundaries are set to &#39;dirichlet&#39; or &#39;neumann&#39; based on the specified external_boundary_type. Internal</span>
<span class="sd">    boundaries are set to &#39;internal&#39;.</span>

<span class="sd">    The function also handles the case where the face is affected by an obstacle. Obstacle boundaries are set to</span>
<span class="sd">    &#39;neumann&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        external_boundaries (np.ndarray): shape=(total_number_cells, 1). Boolean array indicating which faces are</span>
<span class="sd">            external boundaries.</span>
<span class="sd">        site_layout (Union[SiteLayout, None]): SiteLayout object containing obstacle information. Defaults to None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_index</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;internal&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;&lt;U10&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="p">[</span><span class="n">external_boundaries</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_boundary_type</span>
    <span class="k">if</span> <span class="n">site_layout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">faces_affected_obstacle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neighbour_index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">faces_affected_obstacle</span><span class="p">,</span> <span class="n">site_layout</span><span class="o">.</span><span class="n">id_obstacles</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;neumann&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_advection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">assign_advection</span><span class="p">(</span><span class="n">wind_vector</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Assigns the advection terms for the defined set of interfaces to adv_diff_terms['advection'].</p>
<p>Uses an upwind scheme for the discretization of the advection term:
https://en.wikipedia.org/wiki/Upwind_scheme#:~:text=In#20computational#20physics#2C#20the#20term,derivatives#20in#20a#20flow#20field.</p>


<details class="upwind-scheme-for-a-single-dimension-has-the-following-form" open>
  <summary>Upwind scheme for a single dimension has the following form</summary>
  <p>F_i = A * [u^{+} * (c_i - c_{i-1}) + u^{-} * (c_{i+1} - c_{i})]</p>
</details>        <p>where u^{+} = -min(-u, 0) and u^{-} = max(-u, 0), A is the face area, and indices corresponding to other
dimensions have been dropped.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>wind_vector</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). Wind speed vector in dimension of this face
e.g. x, y, z.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">assign_advection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wind_vector</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assigns the advection terms for the defined set of interfaces to adv_diff_terms[&#39;advection&#39;].</span>

<span class="sd">    Uses an upwind scheme for the discretization of the advection term:</span>
<span class="sd">    https://en.wikipedia.org/wiki/Upwind_scheme#:~:text=In#20computational#20physics#2C#20the#20term,derivatives#20in#20a#20flow#20field.</span>

<span class="sd">    Upwind scheme for a single dimension has the following form:</span>
<span class="sd">        F_i = A * [u^{+} * (c_i - c_{i-1}) + u^{-} * (c_{i+1} - c_{i})]</span>
<span class="sd">    where u^{+} = -min(-u, 0) and u^{-} = max(-u, 0), A is the face area, and indices corresponding to other</span>
<span class="sd">    dimensions have been dropped.</span>

<span class="sd">    Args:</span>
<span class="sd">        wind_vector (np.ndarray): shape=(total_number_cells, 1). Wind speed vector in dimension of this face</span>
<span class="sd">            e.g. x, y, z.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;advection&quot;</span><span class="p">]</span>
    <span class="n">u_norm</span> <span class="o">=</span> <span class="n">wind_vector</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">normal</span>
    <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="o">-</span><span class="n">u_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">neighbour_advection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">u_norm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;internal&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>
    <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;dirichlet&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>
    <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;neumann&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">neighbour_advection</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFace.assign_diffusion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">assign_diffusion</span><span class="p">(</span><span class="n">diffusion_constants</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Assigns the diffusion terms for the defined set of interfaces to adv_diff_terms['diffusion'].</p>
<p>If diffusion is already set this function is skipped as the diffusion term is constant.</p>


<details class="the-diffusion-term-for-a-single-dimension-has-the-following-form" open>
  <summary>The diffusion term for a single dimension has the following form</summary>
  <p>G_i = K * A * [(c_{i+1} - c_i) / delta - (c_i - c_{i-1}) / delta]</p>
</details>        <p>where K is the diffusion constant, A is the face area, delta is the cell width, and indices corresponding to
other dimensions have been dropped.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>diffusion_constants (float) </code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>diffusion coefficient in this dimension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">assign_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diffusion_constants</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assigns the diffusion terms for the defined set of interfaces to adv_diff_terms[&#39;diffusion&#39;].</span>

<span class="sd">    If diffusion is already set this function is skipped as the diffusion term is constant.</span>

<span class="sd">    The diffusion term for a single dimension has the following form:</span>
<span class="sd">        G_i = K * A * [(c_{i+1} - c_i) / delta - (c_i - c_{i-1}) / delta]</span>
<span class="sd">    where K is the diffusion constant, A is the face area, delta is the cell width, and indices corresponding to</span>
<span class="sd">    other dimensions have been dropped.</span>

<span class="sd">    Args:</span>
<span class="sd">        diffusion_constants (float) : diffusion coefficient in this dimension.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adv_diff_terms</span><span class="p">[</span><span class="s2">&quot;diffusion&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diffusion_coefficient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_face_area</span> <span class="o">*</span> <span class="n">diffusion_constants</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_width</span>
        <span class="n">term</span><span class="o">.</span><span class="n">B_central</span> <span class="o">=</span> <span class="o">-</span><span class="n">diffusion_coefficient</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">term</span><span class="o">.</span><span class="n">B_neighbour</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;internal&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
        <span class="n">term</span><span class="o">.</span><span class="n">b_dirichlet</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;dirichlet&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
        <span class="n">term</span><span class="o">.</span><span class="n">b_neumann</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_type</span> <span class="o">==</span> <span class="s2">&quot;neumann&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">diffusion_coefficient</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft" class="doc doc-heading">
            <code>FiniteVolumeFaceLeft</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;code&gt;FiniteVolumeFace&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.dispersion_model.finite_volume.FiniteVolumeFace&lt;/code&gt;)" href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace">FiniteVolumeFace</a></code></p>



        <p>Set up face properties specific to a left-facing cell (i.e. outward normal is the negative unit vector).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft.direction">direction</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>direction of the face, either 'left' or 'right'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft.shift">shift</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shift in the grid index to find the neighbour cell. -1 for left face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceLeft.normal">normal</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>normal vector for the face. -1 for left face.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FiniteVolumeFaceLeft</span><span class="p">(</span><span class="n">FiniteVolumeFace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up face properties specific to a left-facing cell (i.e. outward normal is the negative unit vector).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        direction (str): direction of the face, either &#39;left&#39; or &#39;right&#39;.</span>
<span class="sd">        shift (int): shift in the grid index to find the neighbour cell. -1 for left face.</span>
<span class="sd">        normal (int): normal vector for the face. -1 for left face.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span>
    <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">normal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight" class="doc doc-heading">
            <code>FiniteVolumeFaceRight</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="&lt;code&gt;FiniteVolumeFace&lt;/code&gt;


  &lt;span class=&quot;doc doc-labels&quot;&gt;
      &lt;small class=&quot;doc doc-label doc-label-dataclass&quot;&gt;&lt;code&gt;dataclass&lt;/code&gt;&lt;/small&gt;
  &lt;/span&gt; (&lt;code&gt;pyelq.dispersion_model.finite_volume.FiniteVolumeFace&lt;/code&gt;)" href="#pyelq.dispersion_model.finite_volume.FiniteVolumeFace">FiniteVolumeFace</a></code></p>



        <p>Set up face properties specific to a right-facing cell (i.e. outward normal is the positive unit vector).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight.direction">direction</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>direction of the face, either 'left' or 'right'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight.shift">shift</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shift in the grid index to find the neighbour cell. +1 for right face.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.FiniteVolumeFaceRight.normal">normal</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>normal vector for the face. +1 for right face.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FiniteVolumeFaceRight</span><span class="p">(</span><span class="n">FiniteVolumeFace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up face properties specific to a right-facing cell (i.e. outward normal is the positive unit vector).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        direction (str): direction of the face, either &#39;left&#39; or &#39;right&#39;.</span>
<span class="sd">        shift (int): shift in the grid index to find the neighbour cell. +1 for right face.</span>
<span class="sd">        normal (int): normal vector for the face. +1 for right face.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span>
    <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">normal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pyelq.dispersion_model.finite_volume.SolverDiagonals" class="doc doc-heading">
            <code>SolverDiagonals</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>Storage for the diagonals of the solver matrix for the finite volume method on a regular grid.</p>
<p>This class holds the diagonal components to construct the solver matrix. It is used for advection, diffusion and
combined terms.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.SolverDiagonals.B">B</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1 + number_faces). Array containing all solver
diagonals, i.e. containing all diagonals from self.B_central and self.B_neighbour. The first column is the
central diagonal and the remaining columns are the off-diagonal terms.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.SolverDiagonals.B_central">B_central</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). Array containing the central diagonal of the
solver matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.SolverDiagonals.B_neighbour">B_neighbour</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, number_faces). Array containing the
off-diagonals of the solver matrix.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.SolverDiagonals.b_dirichlet">b_dirichlet</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). Vector containing contributions from
Dirichlet boundary conditions at edge cells.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="pyelq.dispersion_model.finite_volume.SolverDiagonals.b_neumann">b_neumann</span></code></td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="numpy.ndarray">ndarray</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shape=(total_number_cells, 1). Vector containing contributions from Neumann
boundary conditions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyelq/dispersion_model/finite_volume.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SolverDiagonals</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storage for the diagonals of the solver matrix for the finite volume method on a regular grid.</span>

<span class="sd">    This class holds the diagonal components to construct the solver matrix. It is used for advection, diffusion and</span>
<span class="sd">    combined terms.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        B (Union[np.ndarray, None]): shape=(total_number_cells, 1 + number_faces). Array containing all solver</span>
<span class="sd">            diagonals, i.e. containing all diagonals from self.B_central and self.B_neighbour. The first column is the</span>
<span class="sd">            central diagonal and the remaining columns are the off-diagonal terms.</span>
<span class="sd">        B_central (Union[np.ndarray, None]): shape=(total_number_cells, 1). Array containing the central diagonal of the</span>
<span class="sd">            solver matrix.</span>
<span class="sd">        B_neighbour (Union[np.ndarray, None]): shape=(total_number_cells, number_faces). Array containing the</span>
<span class="sd">            off-diagonals of the solver matrix.</span>
<span class="sd">        b_dirichlet (Union[np.ndarray, None]): shape=(total_number_cells, 1). Vector containing contributions from</span>
<span class="sd">            Dirichlet boundary conditions at edge cells.</span>
<span class="sd">        b_neumann (Union[np.ndarray, None]): shape=(total_number_cells, 1). Vector containing contributions from Neumann</span>
<span class="sd">            boundary conditions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">B</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">B_central</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">B_neighbour</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">b_dirichlet</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">b_neumann</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.indexes", "navigation.instant", "navigation.tabs", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": {"Pipelines": "pipelines"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>